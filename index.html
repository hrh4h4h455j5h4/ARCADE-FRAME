<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Arcade Studio</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.4.5/gifshot.min.js"></script>
<style>
  html { scroll-behavior: smooth; }
  body {
    background: #0a0a0c; color: white; font-family: sans-serif;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh; margin: 0; padding-bottom: 120px; 
    -webkit-overflow-scrolling: touch; 
    /* RETRO SCANLINE BACKGROUND */
    background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
    background-size: 100% 4px;
    overflow-x: hidden;
  }
  
  /* --- FIXED MENU TOGGLE (ALWAYS ON TOP) --- */
  .menu-toggle {
    position: fixed; 
    top: 15px; left: 15px; 
    background: #1a1a1c; color: #fff; 
    border: 1px solid rgba(255,255,255,0.1); 
    padding: 8px 12px; border-radius: 4px; 
    font-weight: bold; cursor: pointer; 
    z-index: 9999; /* Highest priority */
    font-size: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
  }

  #menu-panel {
    position: fixed; top: 0; left: -260px; width: 240px; height: 100%;
    background: #1a1a1c; padding-top: 60px; 
    transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    z-index: 9998; /* Just below toggle */
    display: flex; flex-direction: column; gap: 10px; padding-left: 15px; padding-right: 15px;
    box-shadow: 2px 0 15px rgba(0,0,0,0.8);
  }
  #menu-panel.open { left: 0; }

  /* STUDIO TOGGLE (TOP RIGHT) */
  #studio-toggle {
    position: absolute; top: 15px; right: 15px; 
    background: #ff0000; color: white;
    border: 2px solid #ffffff; padding: 8px 14px; border-radius: 4px; 
    font-weight: bold; cursor: pointer; 
    z-index: 1000; font-size: 11px;
    text-transform: uppercase; letter-spacing: 1px; 
    box-shadow: 0 0 10px rgba(255,0,0,0.5);
    transition: 0.3s;
  }
  #studio-toggle.gif-active { background: #00ffff; color: #000; box-shadow: 0 0 10px rgba(0,255,255,0.5); }

  .lnk, .music-btn {
    display: flex; align-items: center; gap: 10px; padding: 12px;
    text-decoration: none; color: white; font-size: 13px; font-weight: bold;
    border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05);
  }
  .music-btn { border-color: #ff0000; background: rgba(255,0,0,0.1); justify-content: space-between; }

  h1 {
    color: #fff; margin: 50px 0 0 0; font-family: "Arial Black", sans-serif; font-style: italic;
    font-size: 36px; text-transform: uppercase; letter-spacing: -1px;
    text-shadow: 2px 2px 0px #ff0000, -1px -1px 10px rgba(255, 0, 0, 0.8);
    animation: arcadeBounce 1.8s infinite ease-in-out;
  }
  @keyframes arcadeBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  .sub { color: #fff; font-weight: bold; margin: 2px 0 15px 0; text-transform: uppercase; font-size: 11px; letter-spacing: 2px; }
  
  #box {
    position: relative; width: 310px; height: 310px; border-radius: 50%; overflow: hidden;
    background-image: linear-gradient(45deg,#111 25%,transparent 25%),linear-gradient(-45deg,#111 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#111 75%),linear-gradient(-45deg,transparent 75%,#111 75%);
    background-size: 20px 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 2px solid transparent; 
    -webkit-mask-image: -webkit-radial-gradient(white,black); z-index: 10;
  }
  canvas { position: absolute; top: 0; left: 0; width: 310px; height: 310px; touch-action: none; z-index: 15; }
  
  .ui { margin-top: 20px; width: 300px; display: flex; flex-direction: column; gap: 6px; z-index: 100; position: relative; }
  .btn {
    background: #111; border: 2px solid #fff; color: white; padding: 10px; text-align: center;
    border-radius: 8px; font-weight: bold; display: block; font-size: 12px; cursor: pointer; text-transform: uppercase;
  }
  .btn-r { border-color: #ff0000; }
  .btn-center { border-color: #00ffff; color: #00ffff; margin-bottom: 5px; }

  .lbl { font-size: 9px; color: #888; text-transform: uppercase; margin-top: 2px; display: flex; justify-content: space-between; align-items: center; }
  .val-tag { color: #ff0000; font-weight: bold; font-family: monospace; font-size: 10px; }

  input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 10px 0; cursor: pointer; }
  input[type=range]::-webkit-slider-runnable-track {
    width: 100%; height: 8px; background: linear-gradient(to right, #ff0000 var(--v, 0%), #00ffff var(--v, 0%)); border-radius: 4px;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
    background: #ff0000; margin-top: -6px; box-shadow: 0 0 10px #ff0000; border: 2px solid #ffffff;
  }
  
  #save {
    background: #ff0000; border: none; font-size: 14px; color: white; padding: 12px;
    border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; text-transform: uppercase;
    opacity: 0.4; pointer-events: none;
  }
  #save.active { opacity: 1; pointer-events: auto; }
  
  /* DOWNLOAD GIF BUTTON (Visible immediately after video select) */
  #dl-gif-btn {
    background: #00ffff; color: #000; border: none; font-size: 14px; padding: 12px;
    border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; text-transform: uppercase;
    display: none; box-shadow: 0 0 15px rgba(0,255,255,0.4);
  }

  input[type=file] { display: none; }
  #yt-player, #hidden-video { display: none; }
</style>
</head>
<body onclick="startAudio()">

<button class="menu-toggle" onclick="toggleMenu(event)">MENU ‚ò∞</button>
<button id="studio-toggle" onclick="toggleStudioMode()">GIF STUDIO üé¨</button>

<div id="menu-panel">
  <div class="music-btn" onclick="toggleMusic()">MUSIC CONTROL <span id="m-status" style="color:#ff0000;">ON</span></div>
  <a href="https://discord.gg/ardc" target="_blank" class="lnk" style="border-color:#5865F2;"><span>Discord Server</span></a>
  <a href="https://platopedia.com/groups/arcade" target="_blank" class="lnk" style="border-color:#00ffff;"><span>Arcade Website</span></a>
</div>

<div id="yt-player"></div>
<video id="hidden-video" muted loop playsinline crossorigin="anonymous"></video>

<h1 id="main-title">ARCADE</h1>
<p class="sub" id="main-sub">PICTURE STUDIO</p>

<div id="box"><canvas id="c" width="800" height="800"></canvas></div>

<div class="ui">
  <div id="img-controls">
    <label class="btn" onclick="playClick()">CHOOSE IMAGE<input type="file" id="u1" accept="image/*" onchange="handleFile(event)"></label>
    <label class="btn btn-r" onclick="playClick()">APPLY FRAME<input type="file" id="u2" accept="image/*" onchange="handleFrame(event)"></label>
    <button class="btn btn-center" onclick="centerSubject()">CENTER SUBJECT üéØ</button>
  </div>

  <div id="gif-controls" style="display:none;">
    <label class="btn" style="border-color:#00ffff;" onclick="playClick()">SELECT VIDEO üé•<input type="file" id="v1" accept="video/*" onchange="handleVideo(event)"></label>
    <label class="btn btn-r" onclick="playClick()">APPLY FRAME<input type="file" id="u2_gif" accept="image/*" onchange="handleFrame(event)"></label>
    
    <div class="lbl">GIF SPEED <span id="speed-val" class="val-tag">1.0x</span></div>
    <input type="range" id="speed" min="0.5" max="3.0" step="0.1" value="1.0" oninput="updateSpeed(this.value)">
    
    <button id="dl-gif-btn" onclick="downloadGif()">DOWNLOAD GIF ‚¨áÔ∏è</button>
  </div>
  
  <div class="lbl">SCALE ADJUSTMENT <span id="z-val" class="val-tag">100%</span></div>
  <input type="range" id="z" min="0.1" max="4" step="0.01" value="1" oninput="updateZ(this.value)">
  
  <div class="lbl">CANVAS RADIUS <span id="m-val" class="val-tag">375px</span></div>
  <input type="range" id="m" min="300" max="400" step="1" value="375" oninput="updateM(this.value)">
  
  <button id="save" onclick="downloadPic()">EXPORT PICTURE</button>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
const c=document.getElementById('c'),x=c.getContext('2d'),zSl=document.getElementById('z'),mSl=document.getElementById('m'),sBtn=document.getElementById('save'),panel=document.getElementById('menu-panel'),mStat=document.getElementById('m-status'),toggleBtn=document.getElementById('studio-toggle'),vEl=document.getElementById('hidden-video'),gBtn=document.getElementById('dl-gif-btn');
const zVal=document.getElementById('z-val'),mVal=document.getElementById('m-val'),sVal=document.getElementById('speed-val');
let i=new Image(),f=new Image(),cfg={s:1,m:375,x:400,y:400,r:0,d:false,lx:0,ly:0},player,musicOn=true,audioStarted=false,isGifMode=false,vActive=false,playbackSpeed=1.0;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// 1. MENU CLOSE LOGIC (FIXED)
window.addEventListener('click', (e) => {
  if (panel.classList.contains('open') && !panel.contains(e.target) && !e.target.classList.contains('menu-toggle')) {
    panel.classList.remove('open');
    playClick();
  }
});

function toggleStudioMode() {
    isGifMode = !isGifMode;
    playClick();
    document.getElementById('img-controls').style.display = isGifMode ? 'none' : 'block';
    document.getElementById('gif-controls').style.display = isGifMode ? 'block' : 'none';
    
    sBtn.style.display = isGifMode ? 'none' : 'block';
    // Show download button ONLY if video is already selected
    gBtn.style.display = (isGifMode && vActive) ? 'block' : 'none';
    
    document.getElementById('main-title').innerText = isGifMode ? 'GIF' : 'ARCADE';
    document.getElementById('main-sub').innerText = isGifMode ? 'MOTION STUDIO' : 'PICTURE STUDIO';
    
    if (isGifMode) {
        toggleBtn.innerText = "SWITCH TO PICTURE STUDIO üñºÔ∏è";
        toggleBtn.classList.add('gif-active');
        if(vActive) vEl.play();
    } else {
        toggleBtn.innerText = "GIF STUDIO üé¨";
        toggleBtn.classList.remove('gif-active');
        vEl.pause();
    }
    d();
}

// 2. VIDEO HANDLER - INSTANT PREVIEW
function handleVideo(e) {
    const file = e.target.files[0];
    if (file) {
        vEl.src = URL.createObjectURL(file);
        vEl.onloadedmetadata = () => {
            vActive = true;
            // Auto fit
            cfg.s = Math.max(800/vEl.videoWidth, 800/vEl.videoHeight);
            zSl.value = cfg.s;
            zVal.innerText = Math.round(cfg.s*100)+"%";
            vEl.playbackRate = playbackSpeed;
            vEl.play();
            
            // INSTANTLY Show Download Button (No waiting for render)
            gBtn.style.display = 'block';
            playShutter();
            requestAnimationFrame(drawLoop);
        };
    }
}

function updateSpeed(v) {
    playbackSpeed = parseFloat(v);
    sVal.innerText = playbackSpeed.toFixed(1) + "x";
    vEl.playbackRate = playbackSpeed;
    updateSliderColor(document.getElementById('speed'));
}

// 3. DRAW LOOP (The "Virtual GIF")
function drawLoop() {
    if(isGifMode && vActive) { d(); requestAnimationFrame(drawLoop); }
}

// 4. DOWNLOAD LOGIC (Processing only happens here)
function downloadGif() {
    if (!vActive) return;
    gBtn.innerText = "RENDERING GIF... (PLEASE WAIT)";
    gBtn.disabled = true;

    gifshot.createGIF({
        video: [vEl.src],
        gifWidth: 400,
        gifHeight: 400,
        interval: 0.1 / playbackSpeed,
        numFrames: 15,
        sampleInterval: 12, // Quality setting
    }, function(obj) {
        if(!obj.error) {
            let a = document.createElement('a');
            a.download = 'Arcade_Motion.gif';
            a.href = obj.image;
            a.click();
        }
        gBtn.innerText = "DOWNLOAD GIF ‚¨áÔ∏è";
        gBtn.disabled = false;
    });
}

function d(){
  x.clearRect(0,0,800,800); x.save(); x.beginPath(); x.arc(400,400,cfg.m,0,6.28); x.clip();
  if(isGifMode && vActive){
      let w=vEl.videoWidth*cfg.s, h=vEl.videoHeight*cfg.s;
      x.save(); x.translate(cfg.x, cfg.y); x.drawImage(vEl, -w/2, -h/2, w, h); x.restore();
  } else if(i.src){ 
      let w=i.width*cfg.s, h=i.height*cfg.s; 
      x.save(); x.translate(cfg.x, cfg.y); x.drawImage(i, -w/2, -h/2, w, h); x.restore(); 
  }
  x.restore(); if(f.src) x.drawImage(f, 0, 0, 800, 800);
  if ((i.src && !isGifMode) || (f.src && !isGifMode)) sBtn.classList.add('active');
}

// SHARED UTILITIES
function handleFile(e) {
  let r=new FileReader(); r.onload=v=>{ const nextI = new Image(); nextI.onload=()=>{ i=nextI; cfg.s=Math.max(800/i.width,800/i.height); zSl.value=cfg.s; zVal.innerText=Math.round(cfg.s*100)+"%"; updateSliderColor(zSl); d(); playClick(); }; nextI.src=v.target.result; }; r.readAsDataURL(e.target.files[0]);
}
function handleFrame(e) { 
  let r=new FileReader(); r.onload=v=>{ const nF=new Image(); nF.onload=()=>{ f=nF; d(); playClick(); }; nF.src=v.target.result; }; r.readAsDataURL(e.target.files[0]); 
}
function onYouTubeIframeAPIReady() { player = new YT.Player('yt-player', { height: '0', width: '0', videoId: 'nv_2rz5BFDA', playerVars: { 'autoplay': 1, 'loop': 1, 'playlist': 'nv_2rz5BFDA' }, events: { 'onReady': e => { e.target.setVolume(25); if(musicOn) e.target.playVideo(); } } }); }
function startAudio() { if (audioStarted) return; audioCtx.resume(); if(player && musicOn) player.playVideo(); audioStarted = true; }
function toggleMusic() { startAudio(); playClick(); musicOn = !musicOn; if(musicOn) { player.playVideo(); mStat.innerText = "ON"; mStat.style.color = "#ff0000"; } else { player.pauseVideo(); mStat.innerText = "OFF"; mStat.style.color = "#888"; } }
function toggleMenu(e) { e.stopPropagation(); startAudio(); playClick(); panel.classList.toggle('open'); }
function playClick() { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
function playShutter() { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'square'; osc.frequency.setValueAtTime(200, audioCtx.currentTime); osc.frequency.setValueAtTime(400, audioCtx.currentTime + 0.05); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.15); }
function updateSliderColor(el) { const percent = ((el.value - el.min) / (el.max - el.min)) * 100; el.style.setProperty('--v', percent + '%'); }
function updateZ(v) { cfg.s=parseFloat(v); zVal.innerText=Math.round(v*100)+"%"; d(); }
function updateM(v) { cfg.m=parseInt(v); mVal.innerText=v+"px"; d(); }
function centerSubject() { if(!i.src && !vActive) return; playShutter(); cfg.x = 400; cfg.y = 400; d(); }
function gp(e, idx=0){ let r=c.getBoundingClientRect(), t=e.touches?e.touches[idx]:e; return {x:(t.clientX-r.left)*(800/r.width),y:(t.clientY-r.top)*(800/r.height)}; }
function st(e){ if(e.target==c){ e.preventDefault(); cfg.d=true; let p=gp(e); cfg.lx=p.x-cfg.x; cfg.ly=p.y-cfg.y; } }
function mv(e){ if(cfg.d){ e.preventDefault(); let p=gp(e); cfg.x=p.x-cfg.lx; cfg.y=p.y-cfg.ly; d(); } }
function en(){ cfg.d=false; }
c.ontouchstart=st; window.ontouchmove=mv; window.ontouchend=en;
c.onmousedown=st; window.onmousemove=mv; window.onmouseup=en;
function downloadPic() { if(!i.src && !f.src) return; let a=document.createElement('a'); a.download = 'Arcade_Studio_Picture.png'; a.href=c.toDataURL(); a.click(); }
document.querySelectorAll('input[type=range]').forEach(el => { el.addEventListener('input', () => { updateSliderColor(el); }); updateSliderColor(el); });
</script>
</body>
</html>
